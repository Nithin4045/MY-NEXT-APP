name: Auto Backup to Local

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  create-backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies and build
      run: |
        npm install
        npm run build
        
    - name: Create Complete Backup Package
      run: |
        echo "Creating complete backup package..."
        
        # Create backup folder
        mkdir -p my-next-app-backup
        
        # Copy ALL essential files and folders
        echo "ðŸ“ Copying project structure..."
        cp -r app my-next-app-backup/ 2>/dev/null || echo "app folder not found"
        cp -r src my-next-app-backup/ 2>/dev/null || echo "src folder not found"
        cp -r public my-next-app-backup/ 2>/dev/null || echo "public folder not found"
        cp -r components my-next-app-backup/ 2>/dev/null || echo "components folder not found"
        cp -r lib my-next-app-backup/ 2>/dev/null || echo "lib folder not found"
        
        # Copy all configuration files
        cp package.json my-next-app-backup/
        cp package-lock.json my-next-app-backup/ 2>/dev/null || echo "No package-lock.json"
        cp next.config.* my-next-app-backup/ 2>/dev/null || echo "No next config files"
        cp tsconfig.json my-next-app-backup/ 2>/dev/null || echo "No tsconfig.json"
        cp jsconfig.json my-next-app-backup/ 2>/dev/null || echo "No jsconfig.json"
        cp *.env my-next-app-backup/ 2>/dev/null || echo "No env files"
        cp *.env.local my-next-app-backup/ 2>/dev/null || echo "No env.local files"
        
        # Create improved Windows batch file
        cat > my-next-app-backup/RUN_ME.bat << 'EOF'
@echo off
echo =================================
echo   MY-NEXT-APP - GITHUB BACKUP
echo =================================
echo.
echo ðŸ“¦ Installing dependencies...
call npm install
echo.
echo ðŸ”§ Checking for missing folders...
if not exist "src" mkdir src
if not exist "src\i18n" mkdir src\i18n
echo.
echo ðŸŒ Starting development server...
echo ðŸš€ Open: http://localhost:3000
echo.
call npm run dev
pause
EOF

        # Create Linux/Mac run script
        cat > my-next-app-backup/run.sh << 'EOF'
#!/bin/bash
echo "================================="
echo "  MY-NEXT-APP - GITHUB BACKUP"
echo "================================="
echo ""
echo "ðŸ“¦ Installing dependencies..."
npm install
echo ""
echo "ðŸ”§ Checking for missing folders..."
mkdir -p src
mkdir -p src/i18n
echo ""
echo "ðŸŒ Starting development server..."
npm run dev
EOF
        chmod +x my-next-app-backup/run.sh
        
        # Create comprehensive info file
        cat > my-next-app-backup/BACKUP_INFO.txt << EOF
MY-NEXT-APP COMPLETE BACKUP
===========================
Created: $(date)
Repository: $GITHUB_REPOSITORY
Commit: $(git rev-parse --short HEAD)

BACKUP CONTENTS:
- app/          (App Router pages)
- src/          (Source code - middleware, components, etc.)
- public/       (Static assets)
- package.json  (Dependencies)
- Configuration files

INSTRUCTIONS:
1. Extract this zip file
2. Double-click RUN_ME.bat (Windows)
3. Or run ./run.sh (Linux/Mac)
4. Wait for npm install to complete
5. Server starts automatically at http://localhost:3000

NOTES:
- If you get module errors, check that all required folders exist
- The backup includes the complete project structure
EOF
        
        # Create zip archive
        zip -r my-next-app-backup.zip my-next-app-backup/
        
        echo "âœ… Complete backup created successfully!"
        echo "ðŸ“ Included folders:"
        ls -la my-next-app-backup/
        
    - name: Upload Backup
      uses: actions/upload-artifact@v4
      with:
        name: my-next-app-backup
        path: my-next-app-backup.zip
        retention-days: 7
