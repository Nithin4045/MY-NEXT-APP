name: CI/CD with Auto Backup

on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  build-and-backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm run test -- --watchAll=false || echo "Tests failed or not configured"
      
    - name: Build project
      run: npm run build
      
    - name: Create Ready-to-Run Backup
      run: |
        # Set variables
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "Creating backup for branch: $BRANCH_NAME"
        
        # Create clean backup directory
        mkdir -p times_web_latest
        
        # Copy essential files
        echo "ðŸ“ Copying source files..."
        cp -r src times_web_latest/ 2>/dev/null || echo "src folder not found"
        cp -r pages times_web_latest/ 2>/dev/null || echo "pages folder not found"
        cp -r components times_web_latest/ 2>/dev/null || echo "components folder not found"
        cp -r app times_web_latest/ 2>/dev/null || echo "app folder not found"
        cp -r public times_web_latest/ 2>/dev/null || echo "public folder not found"
        cp -r styles times_web_latest/ 2>/dev/null || echo "styles folder not found"
        
        # Copy configuration files
        cp package.json times_web_latest/
        cp package-lock.json times_web_latest/ 2>/dev/null || cp yarn.lock times_web_latest/ 2>/dev/null || echo "No lock file"
        cp next.config.js times_web_latest/ 2>/dev/null || echo "No next.config.js"
        cp next.config.mjs times_web_latest/ 2>/dev/null || echo "No next.config.mjs"
        cp .env* times_web_latest/ 2>/dev/null || echo "No env files"
        
        # Create Windows run script
        cat > times_web_latest/RUN_ME.bat << 'EOF'
@echo off
title Times_Web - GitHub Auto Backup
echo =================================
echo   TIMES_WEB - AUTO BACKUP
echo =================================
echo Created from GitHub Actions
echo Backup: %~dp0
echo.
echo ðŸ“¦ Installing dependencies...
call npm install
echo.
echo ðŸŒ Starting development server...
echo ðŸš€ Open: http://localhost:3000
echo ðŸ“ Press Ctrl+C to stop the server
echo.
call npm run dev
pause
EOF

        # Create Linux/Mac run script
        cat > times_web_latest/run_me.sh << 'EOF'
#!/bin/bash
echo "================================="
echo "  TIMES_WEB - AUTO BACKUP"
echo "================================="
echo "Created from GitHub Actions"
echo "Backup: $(pwd)"
echo ""
echo "ðŸ“¦ Installing dependencies..."
npm install
echo ""
echo "ðŸŒ Starting development server..."
echo "ðŸš€ Open: http://localhost:3000"
echo "ðŸ“ Press Ctrl+C to stop the server"
echo ""
npm run dev
EOF
        chmod +x times_web_latest/run_me.sh
        
        # Create backup info file
        cat > times_web_latest/BACKUP_INFO.txt << EOF
TIMES_WEB AUTO BACKUP
=====================
Created: $(date)
Commit: $COMMIT_SHA
Branch: $BRANCH_NAME
Workflow: $GITHUB_RUN_ID
Trigger: $GITHUB_EVENT_NAME
Repository: $GITHUB_REPOSITORY

INSTRUCTIONS:
1. Extract this zip file
2. Double-click RUN_ME.bat (Windows)
3. Or run ./run_me.sh (Linux/Mac)
4. Open http://localhost:3000 in browser
5. Project will install dependencies and start automatically

This backup was created automatically every 10 minutes.
EOF

        # Create zip archive with timestamp
        zip -r "times_web_backup_${BRANCH_NAME}_${TIMESTAMP}.zip" times_web_latest/
        
        # Also create a "latest" backup for easy downloading
        zip -r "times_web_latest_backup.zip" times_web_latest/
        
        echo "âœ… Backups created:"
        echo "   - times_web_backup_${BRANCH_NAME}_${TIMESTAMP}.zip"
        echo "   - times_web_latest_backup.zip"
        
    - name: Upload Backup Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: times-web-backups
        path: |
          times_web_backup_*.zip
          times_web_latest_backup.zip
        retention-days: 7
        
    - name: Show Download Instructions
      run: |
        echo "ðŸŽ‰ AUTO BACKUP SYSTEM ACTIVE!"
        echo "=========================================="
        echo "â° SCHEDULE: Runs every 10 minutes"
        echo "ðŸ“¦ DOWNLOAD:"
        echo "   1. Go to: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        echo "   2. Scroll to 'Artifacts' section"
        echo "   3. Download 'times-web-backups'"
        echo "   4. Extract and run RUN_ME.bat"
        echo "=========================================="
        echo "ðŸ”§ TRIGGERS:"
        echo "   - Every 10 minutes (automatically)"
        echo "   - On every code push"
        echo "   - Manual trigger from Actions tab"
        echo "=========================================="
